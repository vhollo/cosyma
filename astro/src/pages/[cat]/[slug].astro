---
import Mozaik from '../../layouts/Mozaik.astro'

//import BlogPostLayout from '../../layouts/BlogPostLayout.astro'
//import BlogPost from '../../components/BlogPost.astro'
import {client} from '../../lib/sanityClient.js';
import { getSanityImageUrl } from '../../utils/helpers.js';
import { allPosts } from '../../lib/api.js';
import { allCategoriesWithPosts } from '../../lib/api.js';
import { catPages } from '../../lib/api.js';

export async function getStaticPaths({rss}) {
  const paths = new Set();
  //const pages = await client.fetch(catPages);
  //const allBlogPosts = await client.fetch(allPosts);
  //console.log(allBlogPosts)
/*
  rss({
    title: 'Example Blog',
    description: 'An example blog on Astro',
    customData: `<language>en-us</language>`,
    items: allBlogPosts.map(item => ({
      title: item.title,
      description: item.description,
      link: `${item.cat?.current}/${item.slug?.current}`,
      pubDate: item.publishedAt,
    })),
  });
*/
        //const pp = Object.entries(allBlogPosts)
        //allBlogPosts.forEach(p => console.log(p.category.slug['hu'].current, p.title))
        //console.log('---')

  const allCategoryData = await client.fetch(allCategoriesWithPosts);
  const cats = allCategoryData.slice()
  cats.map(category => {
    category.menu = new Object()
     const slugs = Object.entries(category.slug)
    //console.log(category.slug.hu.current,category.posts)
    slugs.forEach(([lang, slug]) => {
      category.menu[lang] = new Array()
      
      const filteredPosts = category.posts?.filter((post) => post._lang == lang)
      /*  */
      //console.log(slug.current)
      if (category.order == 'abc') {
        filteredPosts.sort((a, b) => {
          return a.slug.current.localeCompare(b.slug.current)
        })
      }

      // Prepare main Nav (on every post)
      allCategoryData.slice().map(cat => {

        category.menu[lang][slug.current] = new Array()
        const fPosts = cat.posts?.filter(p => p._lang == lang);

        if (cat.abc || cat.order == 'abc') {
          fPosts.sort((a, b) => {
            return a.slug.current.localeCompare(b.slug.current)
          })
        }
        category.menu[lang][slug.current] = fPosts
      })
    

      filteredPosts.map(post => {
        const subCat = allCategoryData.find(c => c.slug[lang].current == post.slug.current)
        //console.log({subCat})
        const subPosts = subCat?.posts?.filter((p) => p._lang == lang && p.slug.current !== post.slug.current)
        
        if (subCat?.order == 'abc') {
          subPosts.sort((a, b) => {
            return a.slug.current?.localeCompare(b.slug.current)
          })
        }

        //gallery: referenced posts should be merged
        post.galleries && post.galleries.map(gal => {
          let prs = []
          gal.posts.map(post => {
            post.refs && prs.push(...post.refs)
          })
          gal.posts.push(...prs)
        })

        post.langs = []
        post.refs && post.refs.map(ref => {
          post.langs[ref._lang] = `/${ref.slug.current}`
        })

        paths.add({params: {cat: slug.current, slug: post.slug.current}, props: {lang: lang, pages: allCategoryData, page: subCat || category, posts: []/*subPosts || filteredPosts*/, post: post}})
      })
    });
  })
  return Array.from(paths)

  /*
  allBlogPosts.map(post => {
    console.log(post.slug)
  })
  return allBlogPosts.map(post => ({params: { slug: post.slug.current }, props: {post}}));
  */
}

const { post } = Astro.props;
//console.log(post.summary)
---

<Mozaik {...Astro.props}/>
